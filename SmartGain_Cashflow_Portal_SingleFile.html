<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Gain Properties • Cashflow Portal</title>
  <link rel="icon" type="image/png" href="favicon.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Host+Grotesk:wght@400;600;700;800&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
/* Smart Gain Properties themed styling */
:root{
  --green: #1B4332;   /* Smart Green */
  --gold:  #D4AF37;   /* Smart Yellow */
  --teal: #A3C9C0;    /* Soft Teal */
  --taupe: #B8A392;   /* Warm Taupe */
  --ivory: #F1EDEB;   /* Pale Ivory */
  --slate: #6D7A7D;   /* Slate Grey */

  --bg: #F1EDEB;
  --card: #FFFFFF;
  --cardTint: rgba(27,67,50,.05);
  --text: #101412;
  --muted: rgba(16,20,18,.72);
  --line: rgba(27,67,50,.16);
  --radius: 18px;
  --shadow: 0 14px 35px rgba(0,0,0,.08);
  --font-head: "Host Grotesk", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  --font-body: "Manrope", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
}
body{
  margin:0;
  font-family: var(--font-body);
  color: var(--text);
  background:
    radial-gradient(1200px 800px at 10% 5%, rgba(27,67,50,.12), transparent 55%),
    radial-gradient(1000px 600px at 90% 15%, rgba(212,175,55,.14), transparent 58%),
    radial-gradient(800px 500px at 50% 100%, rgba(163,201,192,.10), transparent 50%),
    linear-gradient(135deg, rgba(163,201,192,.25), rgba(241,237,235,.90) 50%, rgba(212,175,55,.08));
  min-height: 100vh;
}
.pattern{
  position: fixed;
  inset: 0;
  pointer-events: none;
  opacity: .08;
  background-image:
    repeating-linear-gradient(
      45deg,
      transparent,
      transparent 10px,
      rgba(212,175,55,.15) 10px,
      rgba(212,175,55,.15) 12px,
      transparent 12px,
      transparent 16px,
      rgba(212,175,55,.15) 16px,
      rgba(212,175,55,.15) 18px,
      transparent 18px,
      transparent 28px
    );
  mask-image: radial-gradient(circle at 75% 30%, rgba(0,0,0,1), rgba(0,0,0,.25) 50%, rgba(0,0,0,0) 75%);
}
.pattern::before{
  content: '';
  position: absolute;
  inset: 0;
  background-image:
    repeating-linear-gradient(
      45deg,
      transparent,
      transparent 14px,
      rgba(27,67,50,.12) 14px,
      rgba(27,67,50,.12) 16px,
      transparent 16px,
      transparent 20px,
      rgba(27,67,50,.12) 20px,
      rgba(27,67,50,.12) 22px,
      transparent 22px,
      transparent 36px
    );
  mask-image: radial-gradient(circle at 25% 60%, rgba(0,0,0,.8), rgba(0,0,0,.15) 45%, rgba(0,0,0,0) 70%);
}
.wrap{
  max-width: 1120px;
  margin: 34px auto;
  padding: 0 16px 46px;
  position: relative;
  z-index: 1;
}
header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 16px;
  margin-bottom: 18px;
}
.brandline{
  display:flex;
  align-items:center;
  gap: 10px;
  margin-bottom: 10px;
}
.brandLogo{
  height: 56px;
  width: auto;
  display:block;
  filter: drop-shadow(0 4px 16px rgba(27,67,50,.15));
  transition: transform .2s ease, filter .2s ease;
}
.brandLogo:hover{
  transform: translateY(-1px);
  filter: drop-shadow(0 6px 20px rgba(27,67,50,.20));
}
.brandline .b{
  font-weight: 800;
  font-size: 13px;
  color: var(--green);
  letter-spacing: .3px;
  font-family: var(--font-head);
  text-transform: uppercase;
}
.eyebrow{
  display:inline-flex;
  align-items:center;
  gap: 7px;
  background: linear-gradient(90deg, rgba(27,67,50,.10), rgba(212,175,55,.18));
  color: var(--green);
  font-weight: 700;
  font-size: 12px;
  letter-spacing: .5px;
  padding: 9px 14px;
  border-radius: 999px;
  border: 1.5px solid rgba(27,67,50,.20);
  box-shadow:
    0 2px 8px rgba(27,67,50,.06),
    inset 0 1px 0 rgba(255,255,255,.4);
}
.eyebrow .dot{
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--gold);
  box-shadow:
    0 0 0 3px rgba(212,175,55,.20),
    0 0 8px rgba(212,175,55,.40);
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse{
  0%, 100%{ opacity: 1; transform: scale(1); }
  50%{ opacity: .85; transform: scale(.95); }
}
.title h1{
  margin:0;
  font-size: 32px;
  letter-spacing: .8px;
  font-family: var(--font-head);
  font-weight: 800;
  color: var(--green);
  line-height: 1.2;
}
.title p{
  margin:8px 0 0 0;
  color: var(--muted);
  font-size: 14px;
  line-height: 1.55;
  max-width: 820px;
}
.actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:flex-end;
  margin-top: 4px;
}
button{
  background: rgba(27,67,50,.06);
  color: var(--green);
  border: 1px solid var(--line);
  padding: 11px 16px;
  border-radius: 12px;
  cursor:pointer;
  transition: transform .05s ease, background .2s ease, filter .2s ease, box-shadow .2s ease;
  font-weight: 700;
  font-size: 13px;
  font-family: var(--font-body);
  letter-spacing: .3px;
}
button:hover{
  background: rgba(27,67,50,.09);
  box-shadow: 0 4px 12px rgba(27,67,50,.08);
}
button:active{ transform: translateY(1px); }
.btnPrimary{
  background: linear-gradient(135deg, var(--green) 0%, #0f2a1f 50%, var(--gold) 100%);
  border: 1px solid rgba(212,175,55,.45);
  color: white;
  box-shadow:
    0 2px 8px rgba(27,67,50,.15),
    0 8px 24px rgba(212,175,55,.20);
  position: relative;
  overflow: hidden;
}
.btnPrimary:hover{
  filter: brightness(1.05);
  box-shadow:
    0 4px 12px rgba(27,67,50,.18),
    0 12px 32px rgba(212,175,55,.25);
}
.btnPrimary::before{
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.15), transparent);
  transition: left .3s ease;
}
.btnPrimary:hover::before{
  left: 100%;
}
.grid{
  display:grid;
  grid-template-columns: 1.15fr .85fr;
  gap: 16px;
}
@media (max-width: 960px){
  .grid{ grid-template-columns: 1fr; }
  .actions{ justify-content:flex-start; }
}
.card{
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow:
    0 1px 3px rgba(27,67,50,.05),
    0 8px 24px rgba(27,67,50,.08),
    0 16px 48px rgba(27,67,50,.06);
  overflow:hidden;
  position: relative;
}
.card::before{
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--green) 0%, var(--gold) 100%);
  opacity: .6;
}
.card .head{
  padding: 14px 16px;
  background: linear-gradient(180deg, rgba(27,67,50,.06), transparent);
  border-bottom: 1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
}
.card .head h2{
  margin:0;
  font-size: 13px;
  letter-spacing: .35px;
  text-transform: uppercase;
  color: var(--green);
  font-weight: 900;
  font-family: var(--font-head);
}
.badge{
  font-family: var(--font-body);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: .3px;
  color: var(--green);
  background: linear-gradient(135deg, rgba(212,175,55,.12), rgba(163,201,192,.15));
  border: 1px solid rgba(27,67,50,.20);
  padding: 6px 11px;
  border-radius: 999px;
  box-shadow: 0 2px 6px rgba(27,67,50,.04);
}
.content{ padding: 12px 16px 16px; }
.table{ width:100%; border-collapse: collapse; border-spacing: 0; }
.table th, .table td{
  padding: 11px 10px;
  border-bottom: 1px solid rgba(27,67,50,.08);
  vertical-align: middle;
}
.table tbody tr{
  transition: background .15s ease;
}
.table tbody tr:hover{
  background: rgba(212,175,55,.03);
}
.table th{
  text-align:left;
  font-size: 11px;
  color: var(--muted);
  font-weight: 800;
  letter-spacing: .4px;
  text-transform: uppercase;
  font-family: var(--font-head);
  background: linear-gradient(180deg, rgba(27,67,50,.03), transparent);
}
.label{ font-weight: 700; font-size: 13px; }
.hint{ display:block; margin-top: 3px; color: var(--muted); font-size: 12px; line-height: 1.25; }
input, select{
  width: 100%;
  box-sizing: border-box;
  background: #fff;
  border: 1.5px solid rgba(27,67,50,.20);
  color: var(--text);
  padding: 10px 12px;
  border-radius: 12px;
  outline: none;
  font-size: 13px;
  font-family: var(--font-body);
  transition: border-color .2s ease, box-shadow .2s ease;
}
input::placeholder{ color: rgba(16,20,18,.40); }
input:focus, select:focus{
  border-color: var(--green);
  box-shadow:
    0 0 0 3px rgba(27,67,50,.08),
    0 0 0 1px rgba(212,175,55,.25);
}
input:hover, select:hover{
  border-color: rgba(27,67,50,.35);
}
.row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
@media (max-width: 720px){ .row3{ grid-template-columns: 1fr; } }
@media (max-width: 520px){ .row2{ grid-template-columns: 1fr; } }
.kpi{ display:grid; grid-template-columns: 1fr; gap: 10px; }
.kpiCard{
  background: linear-gradient(180deg, var(--cardTint), #fff);
  border: 1px solid rgba(27,67,50,.14);
  border-radius: 14px;
  padding: 14px 14px;
  box-shadow:
    0 1px 3px rgba(27,67,50,.04),
    0 4px 8px rgba(27,67,50,.02);
  transition: transform .2s ease, box-shadow .2s ease;
}
.kpiCard:hover{
  transform: translateY(-1px);
  box-shadow:
    0 2px 6px rgba(27,67,50,.06),
    0 8px 16px rgba(27,67,50,.04);
}
.kpiCard .k{
  color: var(--muted);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: .25px;
  margin-bottom: 6px;
  font-weight: 900;
  font-family: var(--font-head);
}
.kpiCard .v{
  font-family: var(--font-head);
  font-size: 20px;
  font-weight: 800;
  letter-spacing: .3px;
  color: var(--green);
  line-height: 1.3;
}
.kpiHero{
  border: 1px solid rgba(212,175,55,.40);
  box-shadow:
    0 4px 12px rgba(212,175,55,.12),
    0 12px 32px rgba(27,67,50,.08),
    inset 0 1px 0 rgba(255,255,255,.5);
  background: linear-gradient(135deg, rgba(27,67,50,.08), rgba(212,175,55,.14), rgba(163,201,192,.10));
  position: relative;
  overflow: hidden;
}
.kpiHero::before{
  content: '';
  position: absolute;
  top: -50%;
  right: -20%;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(212,175,55,.15), transparent 70%);
  pointer-events: none;
}
.split{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
@media (max-width: 960px){ .split{ grid-template-columns: 1fr; } }
.footerNote{ color: var(--muted); font-size: 12px; margin-top: 12px; line-height: 1.4; }
.tiny{ font-size: 11px; color: var(--muted); font-family: var(--mono); }
.hr{ height: 1px; background: rgba(27,67,50,.12); margin: 10px 0 0; }

/* Collapsible Section */
.collapsible-header{
  cursor: pointer;
  user-select: none;
  transition: background 0.2s ease;
  position: relative;
}
.collapsible-header::after{
  content: 'Click to expand';
  position: absolute;
  right: 180px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  color: var(--muted);
  font-weight: 600;
  font-family: var(--font-body);
  opacity: 0.7;
  pointer-events: none;
}
.collapsible-header.active::after{
  content: 'Click to collapse';
}
@media (max-width: 640px){
  .collapsible-header::after{
    display: none;
  }
}
.collapsible-header:hover{
  background: linear-gradient(180deg, rgba(27,67,50,.08), rgba(27,67,50,.02));
}
.collapsible-header:hover::after{
  opacity: 1;
}
.collapsible-toggle{
  display: inline-block;
  margin-left: 8px;
  transition: transform 0.3s ease;
  font-size: 14px;
  color: var(--green);
  font-weight: 700;
}
.collapsible-header.active .collapsible-toggle{
  transform: rotate(180deg);
}
.collapsible-content{
  display: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.collapsible-content.active{
  display: block;
  animation: fadeIn 0.3s ease forwards;
}
@keyframes fadeIn{
  from{ opacity: 0; }
  to{ opacity: 1; }
}

/* Warning Modal Styles */
.modal-overlay{
  position: fixed;
  inset: 0;
  background: rgba(16, 20, 18, 0.85);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 20px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.modal-overlay.active{
  opacity: 1;
  pointer-events: all;
}
.modal-dialog{
  background: var(--card);
  border: 2px solid var(--gold);
  border-radius: var(--radius);
  max-width: 580px;
  width: 100%;
  box-shadow:
    0 24px 48px rgba(0, 0, 0, 0.25),
    0 8px 16px rgba(27, 67, 50, 0.15),
    0 0 0 1px rgba(212, 175, 55, 0.3);
  position: relative;
  transform: scale(0.95);
  transition: transform 0.3s ease;
}
.modal-overlay.active .modal-dialog{
  transform: scale(1);
}
.modal-dialog::before{
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--green) 0%, var(--gold) 100%);
}
.modal-header{
  padding: 24px 24px 16px;
  border-bottom: 1px solid var(--line);
  background: linear-gradient(180deg, rgba(27, 67, 50, 0.04), transparent);
}
.modal-header h3{
  margin: 0 0 6px 0;
  font-size: 22px;
  font-weight: 800;
  font-family: var(--font-head);
  color: var(--green);
  display: flex;
  align-items: center;
  gap: 10px;
}
.modal-icon{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, rgba(212, 175, 55, 0.20), rgba(212, 175, 55, 0.10));
  border: 2px solid rgba(212, 175, 55, 0.40);
  font-size: 18px;
  color: var(--gold);
}
.modal-subtitle{
  margin: 0;
  font-size: 13px;
  color: var(--muted);
  font-weight: 600;
  letter-spacing: 0.3px;
}
.modal-body{
  padding: 20px 24px;
  font-size: 14px;
  line-height: 1.65;
  color: var(--text);
}
.modal-body p{
  margin: 0 0 14px 0;
}
.modal-body p:last-child{
  margin-bottom: 0;
}
.modal-body strong{
  font-weight: 700;
  color: var(--green);
}
.modal-body ul{
  margin: 12px 0;
  padding-left: 20px;
}
.modal-body ul li{
  margin-bottom: 8px;
}
.modal-footer{
  padding: 16px 24px 24px;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  border-top: 1px solid var(--line);
  background: linear-gradient(0deg, rgba(27, 67, 50, 0.02), transparent);
}
.modal-btn{
  background: linear-gradient(135deg, var(--green) 0%, #0f2a1f 50%, var(--gold) 100%);
  border: 1px solid rgba(212, 175, 55, 0.45);
  color: white;
  padding: 13px 28px;
  border-radius: 12px;
  cursor: pointer;
  transition: transform 0.05s ease, filter 0.2s ease, box-shadow 0.2s ease;
  font-weight: 700;
  font-size: 14px;
  font-family: var(--font-body);
  letter-spacing: 0.3px;
  box-shadow:
    0 2px 8px rgba(27, 67, 50, 0.15),
    0 8px 24px rgba(212, 175, 55, 0.20);
  position: relative;
  overflow: hidden;
}
.modal-btn:hover{
  filter: brightness(1.05);
  box-shadow:
    0 4px 12px rgba(27, 67, 50, 0.18),
    0 12px 32px rgba(212, 175, 55, 0.25);
}
.modal-btn:active{
  transform: translateY(1px);
}
.modal-btn::before{
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
  transition: left 0.3s ease;
}
.modal-btn:hover::before{
  left: 100%;
}
@media (max-width: 640px){
  .modal-dialog{
    max-width: 100%;
  }
  .modal-header h3{
    font-size: 19px;
  }
  .modal-body{
    font-size: 13px;
  }
}

  </style>
</head>

<body>
  <!-- Data Warning Modal -->
  <div class="modal-overlay" id="warningModal" role="dialog" aria-labelledby="modalTitle" aria-describedby="modalDesc">
    <div class="modal-dialog" role="document">
      <div class="modal-header">
        <h3 id="modalTitle">
          <span class="modal-icon" aria-hidden="true">⚠</span>
          Important Disclaimer
        </h3>
        <p class="modal-subtitle">Please read before proceeding</p>
      </div>
      <div class="modal-body" id="modalDesc">
        <p><strong>This calculator provides estimates only.</strong> The data, calculations, and projections shown in this portal are for informational and illustrative purposes and should not be relied upon as financial, investment, or legal advice.</p>
        <p>Please note:</p>
        <ul>
          <li>Property values, market conditions, and financial metrics may vary and could be outdated</li>
          <li>Calculations are based on simplified assumptions and may not reflect actual costs or returns</li>
          <li>This tool does not constitute professional financial advice or recommendations</li>
          <li>Always consult with qualified financial, legal, and tax professionals before making investment decisions</li>
        </ul>
        <p><strong>By proceeding, you acknowledge that you use this calculator at your own risk and that Smart Gain Properties assumes no liability for decisions made based on this information.</strong></p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn" id="acceptWarning" aria-label="Accept and continue">I Understand &amp; Accept</button>
      </div>
    </div>
  </div>

  <div class="pattern" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <div class="title">
        <div class="brandline">
          <img src="Logo Full - Color.png" alt="Smart Gain Properties logo" class="brandLogo">
        </div>
        <div class="eyebrow"><span class="dot" aria-hidden="true"></span>Cashflow &amp; Portfolio Snapshot</div>

        <h1>Investment Cashflow Portal</h1>
        <p>
          Percent fields accept either <b>20</b> or <b>0.20</b>. LMI + stamp duty are auto (estimate).
          Depreciation is auto-estimated. Tax deductible ratio defaults to <b>100%</b>.
          Loan is <b>P&amp;I from day 1</b>.
        </p>
      </div>

      <div class="actions">
        <button id="btnReset">Reset</button>
        <button class="btnPrimary" id="btnExport">Copy Inputs</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="head">
          <h2>Inputs</h2>
          <span class="badge">Editable</span>
        </div>

        <div class="content">
          <table class="table" aria-label="inputs">
            <tbody>
              <tr>
                <td class="label">Property Address</td>
                <td><input id="address" type="text" placeholder="5 Henschke Court, Caboolture QLD 4510"></td>
              </tr>

              <tr>
                <td class="label">State</td>
                <td>
                  <select id="state">
                    <option>QLD</option><option>NSW</option><option>VIC</option><option>SA</option>
                    <option>WA</option><option>TAS</option><option>ACT</option><option>NT</option>
                  </select>
                </td>
              </tr>

              <tr><td class="label">Purchase Price</td><td><input id="purchasePrice" type="number" min="0" step="1000" placeholder="565000"></td></tr>
              <tr><td class="label">Deposit %</td><td><input id="depositPct" type="number" min="0" step="0.01" placeholder="20"></td></tr>
              <tr><td class="label">Interest Rate % (p.a.)</td><td><input id="interestRate" type="number" min="0" step="0.0001" placeholder="5.5"></td></tr>
              <tr><td class="label">Loan Term (years)</td><td><input id="loanTermYears" type="number" min="1" step="1" placeholder="30"></td></tr>

              <tr>
                <td colspan="2">
                  <div class="row2">
                    <div>
                      <label class="label">Rent / week</label>
                      <input id="rentWeek" type="number" min="0" step="5" placeholder="550">
                    </div>
                    <div>
                      <label class="label">Rental Commission %</label>
                      <input id="rentComm" type="number" min="0" step="0.01" placeholder="8">
                    </div>
                  </div>
                </td>
              </tr>

              <tr>
                <td colspan="2">
                  <div class="row2">
                    <div>
                      <label class="label">Council Rate / yr</label>
                      <input id="councilYr" type="number" min="0" step="50" placeholder="4000">
                    </div>
                    <div>
                      <label class="label">Building Insurance / yr</label>
                      <input id="buildingInsYr" type="number" min="0" step="50" placeholder="1500">
                    </div>
                  </div>
                </td>
              </tr>

              <tr>
                <td colspan="2">
                  <div class="row2">
                    <div>
                      <label class="label">Landlord Insurance / yr</label>
                      <input id="landlordInsYr" type="number" min="0" step="50" placeholder="500">
                    </div>
                    <div>
                      <label class="label">Maintenance / yr</label>
                      <input id="maintenanceYr" type="number" min="0" step="50" placeholder="3000">
                    </div>
                  </div>
                </td>
              </tr>

              <tr><td class="label">Accounting Fees / yr</td><td><input id="accountingYr" type="number" min="0" step="50" placeholder="0"></td></tr>
              <tr><td class="label">Super Contribution / yr</td><td><input id="superYr" type="number" min="0" step="50" placeholder="0"></td></tr>

              <tr>
                <td colspan="2">
                  <div class="row2">
                    <div>
                      <label class="label">Building Value %</label>
                      <input id="buildingValuePct" type="number" min="0" step="0.1" placeholder="70">
                      <span class="hint">Used only for depreciation estimate</span>
                    </div>
                    <div>
                      <label class="label">Depreciation Rate %</label>
                      <input id="deprRatePct" type="number" min="0" step="0.1" placeholder="2.5">
                      <span class="hint">2.5% is a common estimate</span>
                    </div>
                  </div>
                </td>
              </tr>

              <tr><td class="label">Tax Deductible Ratio %</td><td><input id="taxDeductRatio" type="number" min="0" step="0.01" placeholder="100"></td></tr>
              <tr><td class="label">Marginal Tax Rate %</td><td><input id="taxRate" type="number" min="0" step="0.01" placeholder="30"></td></tr>
            </tbody>
          </table>

          <div class="footerNote">Tip: enter <b>5.5</b> (or <b>0.055</b>) for Interest Rate.</div>
        </div>
      </section>

      <section class="card">
        <div class="head">
          <h2>Outputs</h2>
          <span class="badge">Auto calculated</span>
        </div>

        <div class="content">
          <div class="kpi">
            <div class="kpiCard kpiHero">
              <div class="k">Cash Required</div>
              <div class="v" id="outCashRequired">$0</div>
              <div class="hint" id="outCashRequiredSub">Deposit + LMI + stamp duty</div>
            </div>

            <div class="split">
              <div class="kpiCard">
                <div class="k">Monthly Repayment (P&amp;I)</div>
                <div class="v" id="outMonthlyPAndI">$0</div>
              </div>
              <div class="kpiCard">
                <div class="k">Interest portion (month 1)</div>
                <div class="v" id="outInterestOnly">$0</div>
              </div>
            </div>

            <div class="split">
              <div class="kpiCard">
                <div class="k">Net Rental / yr</div>
                <div class="v" id="outNetRentYr">$0</div>
              </div>
              <div class="kpiCard">
                <div class="k">Rental Yield (gross)</div>
                <div class="v" id="outYield">0.00%</div>
              </div>
            </div>

            <div class="split">
              <div class="kpiCard">
                <div class="k">Annual Expense</div>
                <div class="v" id="outExpenseYr">$0</div>
              </div>
              <div class="kpiCard">
                <div class="k">Net Cashflow / yr (pre-tax)</div>
                <div class="v" id="outCashflowYrPreTax">$0</div>
              </div>
            </div>

            <div class="kpiCard kpiHero">
              <div class="k">Net Cashflow / month</div>
              <div class="v" id="outNetCashMonth">$0</div>
              <div class="hint">Negative = out-of-pocket (shown in brackets)</div>
            </div>

            <div class="hr"></div>

            <table class="table" aria-label="details">
              <thead><tr><th>Metric</th><th style="text-align:right">Value</th></tr></thead>
              <tbody>
                <tr><td class="label">Deposit</td><td style="text-align:right" class="tiny" id="outDeposit">$0</td></tr>
                <tr><td class="label">Loan Amount (start)</td><td style="text-align:right" class="tiny" id="outLoanAmt">$0</td></tr>
                <tr><td class="label">LVR</td><td style="text-align:right" class="tiny" id="outLvr">0%</td></tr>
                <tr><td class="label">LMI (auto)</td><td style="text-align:right" class="tiny" id="outLmi">$0</td></tr>
                <tr><td class="label">Stamp Duty (auto)</td><td style="text-align:right" class="tiny" id="outDuty">$0</td></tr>
                <tr><td class="label">Depreciation / yr (auto)</td><td style="text-align:right" class="tiny" id="outDepr">$0</td></tr>
                <tr><td class="label">Monthly cashflow (pre-tax)</td><td style="text-align:right" class="tiny" id="outCashPreTax">$0</td></tr>
                <tr><td class="label">Tax benefit</td><td style="text-align:right" class="tiny" id="outTaxBenefit">$0</td></tr>
              </tbody>
            </table>

            <div class="footerNote" id="reportLine"></div>
          </div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:16px;">
      <div class="head collapsible-header" id="advancedHeader">
        <h2>Advanced <span class="collapsible-toggle">▼</span></h2>
        <span class="badge">Portfolio Projection</span>
      </div>

      <div class="content collapsible-content" id="advancedContent">
        <div class="row3">
          <div>
            <div class="label">Average Annual Growth %</div>
            <input id="capGrowthPct" type="number" min="0" step="0.01" placeholder="6.0">
            <div class="hint">Used to project property value</div>
          </div>
          <div>
            <div class="label">Rental Growth %</div>
            <input id="rentGrowthPct" type="number" min="0" step="0.01" placeholder="3.0">
            <div class="hint">Used to project rent (weekly)</div>
          </div>
          <div>
            <div class="label">Cashflow Adjustment %</div>
            <input id="cashflowGrowthPct" type="number" min="0" step="0.01" placeholder="2.0">
            <div class="hint">Optional. Grows your net cashflow</div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <canvas id="portfolioChart" height="160" style="width:100%; display:block;"></canvas>
          <div class="footerNote" id="chartCaption"></div>
        </div>

        <div style="margin-top:10px;">
          <table class="table" aria-label="projection table">
            <thead>
              <tr>
                <th>Year</th>
                <th style="text-align:right;">Property Value</th>
                <th style="text-align:right;">Loan Balance</th>
                <th style="text-align:right;">Equity</th>
                <th style="text-align:right;">Rent / week</th>
                <th style="text-align:right;">Net Cashflow / year</th>
              </tr>
            </thead>
            <tbody id="projectionRows"></tbody>
          </table>
        </div>

        <div class="footerNote">
          Loan balance amortises with standard P&amp;I (fixed payment; balance reduces). Chart includes Year 0 baseline.
        </div>
      </div>
    </section>
  </div>

  <script>
const $ = (id) => document.getElementById(id);

const fmtAUD0 = (n) => (isFinite(n) ? n : 0).toLocaleString("en-AU", { style:"currency", currency:"AUD", maximumFractionDigits:0 });
const fmtAUD2 = (n) => (isFinite(n) ? n : 0).toLocaleString("en-AU", { style:"currency", currency:"AUD", maximumFractionDigits:2 });
const fmtPct  = (n) => ((isFinite(n) ? n : 0) * 100).toFixed(2) + "%";

function fmtSignedAUD(n, decimals=2){
  const v = isFinite(n) ? n : 0;
  const abs = Math.abs(v).toLocaleString("en-AU", { style:"currency", currency:"AUD", maximumFractionDigits:decimals });
  if (v < 0) return "(" + abs + ")";
  return abs;
}
function fmtOutflowAUD(n, decimals=0){
  const v = isFinite(n) ? Math.abs(n) : 0;
  const abs = v.toLocaleString("en-AU", { style:"currency", currency:"AUD", maximumFractionDigits:decimals });
  return "(" + abs + ")";
}

// Monthly payment for amortising loan
function pmt(rate, nper, pv){
  if (!isFinite(rate) || !isFinite(nper) || !isFinite(pv) || nper <= 0) return 0;
  if (rate === 0) return pv / nper;
  const pow = Math.pow(1 + rate, nper);
  return (pv * rate * pow) / (pow - 1);
}

// Remaining balance after m payments (closed form)
function remainingBalance(pv, rate, payment, m){
  if (!isFinite(pv) || !isFinite(rate) || !isFinite(payment) || !isFinite(m) || m <= 0) return pv;
  if (rate === 0) return Math.max(0, pv - payment * m);
  const pow = Math.pow(1 + rate, m);
  const bal = pv * pow - payment * ((pow - 1) / rate);
  return Math.max(0, bal);
}

// Accept 20 or 0.20
function parsePercentLoose(x){
  const v = parseFloat(x);
  if (!isFinite(v)) return 0;
  return (v > 1) ? (v / 100) : v;
}
function clamp01(x){ return Math.min(1, Math.max(0, x)); }

// Simple LMI schedule (editable later to match your preferred lender table)
const LMI_TIERS = [
  { lvrMax: 0.80, rate: 0.0000 },
  { lvrMax: 0.85, rate: 0.0060 },
  { lvrMax: 0.90, rate: 0.0120 },
  { lvrMax: 0.92, rate: 0.0140 },
  { lvrMax: 0.95, rate: 0.0200 },
  { lvrMax: 1.00, rate: 0.0300 }
];

// Approx stamp duty (replace with exact state schedule if you want)
function calcStampDuty(state, price){
  if (!isFinite(price) || price <= 0) return 0;

  if (state === "QLD"){
    if (price <= 540000) return price * 0.0325;
    return (540000 * 0.0325) + ((price - 540000) * 0.0400);
  }
  if (state === "NSW"){
    if (price <= 1000000) return price * 0.035;
    return (1000000 * 0.035) + ((price - 1000000) * 0.045);
  }
  if (state === "VIC"){
    if (price <= 960000) return price * 0.050;
    return (960000 * 0.050) + ((price - 960000) * 0.055);
  }
  return price * 0.040;
}

function calcLmi(lvr, loanAmount){
  if (!isFinite(lvr) || !isFinite(loanAmount) || loanAmount <= 0) return 0;
  for (const t of LMI_TIERS){
    if (lvr <= t.lvrMax) return loanAmount * t.rate;
  }
  return loanAmount * 0.03;
}

function getInputs(){
  return {
    address: $("address").value.trim(),
    state: $("state").value,
    purchasePrice: parseFloat($("purchasePrice").value) || 0,

    depositPct: parsePercentLoose($("depositPct").value),
    interestRate: parsePercentLoose($("interestRate").value),
    rentComm: parsePercentLoose($("rentComm").value),

    loanTermYears: parseFloat($("loanTermYears").value) || 0,

    rentWeek: parseFloat($("rentWeek").value) || 0,

    councilYr: parseFloat($("councilYr").value) || 0,
    buildingInsYr: parseFloat($("buildingInsYr").value) || 0,
    landlordInsYr: parseFloat($("landlordInsYr").value) || 0,
    maintenanceYr: parseFloat($("maintenanceYr").value) || 0,
    accountingYr: parseFloat($("accountingYr").value) || 0,
    superYr: parseFloat($("superYr").value) || 0,

    buildingValuePct: parsePercentLoose($("buildingValuePct").value),
    deprRatePct: parsePercentLoose($("deprRatePct").value),

    taxDeductRatio: parsePercentLoose($("taxDeductRatio").value),
    taxRate: parsePercentLoose($("taxRate").value),

    capGrowth: parsePercentLoose($("capGrowthPct").value || "6"),
    rentGrowth: parsePercentLoose($("rentGrowthPct").value || "3"),
    cashGrowth: parsePercentLoose($("cashflowGrowthPct").value || "0")
  };
}

function compute(i){
  const depositPct = clamp01(i.depositPct);
  const rentComm = clamp01(i.rentComm);

  const buildingValuePct = clamp01(i.buildingValuePct || 0.70);
  const deprRatePct = clamp01(i.deprRatePct || 0.025);

  const taxDeductWasBlank = $("taxDeductRatio").value.trim() === "";
  const taxDeductRatio = clamp01(taxDeductWasBlank ? 1 : i.taxDeductRatio);
  const taxRate = clamp01(i.taxRate);

  const loanAmount = i.purchasePrice * (1 - depositPct);
  const deposit = i.purchasePrice * depositPct;
  const lvr = (i.purchasePrice > 0) ? (loanAmount / i.purchasePrice) : 0;

  const stampDuty = calcStampDuty(i.state, i.purchasePrice);
  const lmi = calcLmi(lvr, loanAmount);
  const cashRequired = deposit + lmi + stampDuty;

  const monthlyRate = i.interestRate / 12;
  const nper = i.loanTermYears * 12;

  const monthlyPAndI = pmt(monthlyRate, nper, loanAmount);

  const interestPortionMonth1 = loanAmount * i.interestRate / 12;

  const annualExpense =
    (monthlyPAndI * 12) +
    i.councilYr + i.buildingInsYr + i.landlordInsYr + i.maintenanceYr + i.accountingYr;

  const netRentYr = i.rentWeek * 52 * (1 - rentComm);
  const yieldGross = (i.purchasePrice > 0) ? ((i.rentWeek * 52) / i.purchasePrice) : 0;

  const cashflowYrPreTax = netRentYr - annualExpense - i.superYr;
  const cashflowMonthPreTax = cashflowYrPreTax / 12;

  const depreciationYr = i.purchasePrice * buildingValuePct * deprRatePct;

  const netExpTax = (Math.abs(cashflowYrPreTax) - depreciationYr) * taxDeductRatio;
  const taxBenefit = netExpTax * taxRate;

  const cashflowYrAfterTax = cashflowYrPreTax + taxBenefit;
  const cashflowMonthAfterTax = cashflowYrAfterTax / 12;

  return {
    loanAmount, deposit, lvr,
    stampDuty, lmi, cashRequired,
    monthlyRate, nper, monthlyPAndI, interestPortionMonth1,
    annualExpense, netRentYr, yieldGross,
    cashflowYrPreTax, cashflowMonthPreTax,
    depreciationYr, taxBenefit,
    cashflowYrAfterTax, cashflowMonthAfterTax
  };
}

function projectValue(base, annualRate, years){
  return base * Math.pow(1 + annualRate, years);
}

// Calculate cash flow for a specific year in the projection
function calculateYearCashflow(year, baseInputs, baseComputed){
  const rentGrowth = parsePercentLoose($("rentGrowthPct").value || "3");
  const expenseGrowth = parsePercentLoose($("cashflowGrowthPct").value || "2");

  // Project rent for this year
  const projectedRentWk = baseInputs.rentWeek * Math.pow(1 + rentGrowth, year);
  const rentComm = parsePercentLoose(baseInputs.rentComm);
  const netRentYr = projectedRentWk * 52 * (1 - rentComm);

  // Calculate remaining balance and interest for this year
  const months = Math.min(year * 12, baseComputed.nper);
  const balanceStart = remainingBalance(baseComputed.loanAmount, baseComputed.monthlyRate, baseComputed.monthlyPAndI, months);
  const balanceEnd = remainingBalance(baseComputed.loanAmount, baseComputed.monthlyRate, baseComputed.monthlyPAndI, Math.min(months + 12, baseComputed.nper));

  // Calculate interest paid during this year
  // For P&I loan, we can calculate total payments minus principal reduction
  const principalPaid = balanceStart - balanceEnd;
  const totalPayments = baseComputed.monthlyPAndI * Math.min(12, baseComputed.nper - months);
  const interestPaid = totalPayments - principalPaid;

  // Project other expenses with expense growth
  const councilYr = baseInputs.councilYr * Math.pow(1 + expenseGrowth, year);
  const buildingInsYr = baseInputs.buildingInsYr * Math.pow(1 + expenseGrowth, year);
  const landlordInsYr = baseInputs.landlordInsYr * Math.pow(1 + expenseGrowth, year);
  const maintenanceYr = baseInputs.maintenanceYr * Math.pow(1 + expenseGrowth, year);
  const accountingYr = baseInputs.accountingYr * Math.pow(1 + expenseGrowth, year);
  const otherExpenses = councilYr + buildingInsYr + landlordInsYr + maintenanceYr + accountingYr;

  // Total annual expense (P&I + other expenses)
  const annualExpense = totalPayments + otherExpenses;

  // Pre-tax cash flow
  const cashflowYrPreTax = netRentYr - annualExpense - baseInputs.superYr;

  // Depreciation (decreases over time but we'll use a simplified approach)
  const buildingValuePct = parsePercentLoose(baseInputs.buildingValuePct || 70);
  const deprRatePct = parsePercentLoose(baseInputs.deprRatePct || 2.5);
  const depreciationYr = baseInputs.purchasePrice * buildingValuePct * deprRatePct;

  // Tax deductible amount: interest + other expenses + depreciation
  const taxDeductRatio = parsePercentLoose(baseInputs.taxDeductRatio || 100);
  const taxRate = parsePercentLoose(baseInputs.taxRate);

  // Only interest and other expenses are deductible, NOT principal
  const deductibleExpenses = interestPaid + otherExpenses;
  const taxableIncome = netRentYr - deductibleExpenses;

  let taxBenefit = 0;
  if (taxableIncome < 0) {
    // Negative taxable income = tax benefit from loss
    taxBenefit = Math.abs(taxableIncome + depreciationYr) * taxDeductRatio * taxRate;
  } else {
    // Positive taxable income = tax liability (but we also get depreciation benefit)
    taxBenefit = depreciationYr * taxDeductRatio * taxRate;
  }

  const cashflowYrAfterTax = cashflowYrPreTax + taxBenefit;

  return cashflowYrAfterTax;
}

function renderProjection(baseComputed, baseInputs){
  // Fixed projection years for simplicity
  const years = [0, 1, 2, 3, 5, 10, 20, 30];

  const capGrowth = parsePercentLoose($("capGrowthPct").value || "6");
  const rentGrowth = parsePercentLoose($("rentGrowthPct").value || "3");

  const baseValue = baseInputs.purchasePrice;
  const baseRentWk = baseInputs.rentWeek;

  const pv = baseComputed.loanAmount;
  const r = baseComputed.monthlyRate;
  const payment = baseComputed.monthlyPAndI;
  const nper = baseComputed.nper;

  const rows = [];
  const xVals = [];
  const values = [];
  const balances = [];

  for(const y of years){
    const months = Math.min(y * 12, nper);
    const v = projectValue(baseValue, capGrowth, y);
    const rw = projectValue(baseRentWk, rentGrowth, y);
    const bal = remainingBalance(pv, r, payment, months);
    const eq = Math.max(0, v - bal);

    // Calculate actual cash flow for this year
    let cash;
    if (y === 0) {
      cash = baseComputed.cashflowMonthAfterTax * 12;
    } else {
      cash = calculateYearCashflow(y, baseInputs, baseComputed);
    }

    xVals.push(y);
    values.push(v);
    balances.push(bal);

    rows.push({y, v, bal, eq, rw, cash});
  }

  $("projectionRows").innerHTML = rows.map(row => `
    <tr>
      <td class="label">Year ${row.y}</td>
      <td style="text-align:right;" class="tiny">${fmtAUD0(row.v)}</td>
      <td style="text-align:right;" class="tiny">${fmtAUD0(row.bal)}</td>
      <td style="text-align:right;" class="tiny">${fmtAUD0(row.eq)}</td>
      <td style="text-align:right;" class="tiny">${fmtAUD2(row.rw)}</td>
      <td style="text-align:right;" class="tiny">${fmtSignedAUD(row.cash, 0)}</td>
    </tr>
  `).join("");

  const canvas = $("portfolioChart");
  const caption = $("chartCaption");

  // Always show Value + Loan Balance view (simplified)
  caption.innerHTML = "Chart shows projected <b>Property Value</b> and <b>Loan Balance</b> over time. Includes <b>Year 0</b> baseline.";
  drawDualAxis(canvas, xVals, values, balances, "Value", "Loan");
}

// ============================================================================
// CHART SYSTEM - Modular Architecture
// ============================================================================

/**
 * ChartConfig - Central configuration for chart styling and layout
 */
class ChartConfig {
  constructor(options = {}) {
    // Colors from CSS variables
    this.colors = {
      primary: '#1B4332',      // Smart Green
      secondary: '#D4AF37',    // Smart Gold
      grid: 'rgba(27,67,50,.14)',
      label: 'rgba(16,20,18,.65)',
      legendLabel: 'rgba(16,20,18,.75)'
    };

    // Layout
    this.padding = {
      left: 56,
      right: 50,
      top: 26,
      bottom: 34
    };

    // Typography
    this.font = {
      size: 12,
      family: getComputedStyle(document.body).fontFamily
    };

    // Visual elements
    this.line = {
      width: 2.5,
      pointRadius: 3.5
    };

    this.grid = {
      lineWidth: 1,
      divisions: 4
    };

    this.legend = {
      boxSize: 12,
      spacing: 92,
      offset: { x: 18, y: 10 }
    };

    // Axis settings
    this.axis = {
      topMargin: 1.06,      // 6% margin above max value
      rightAxisMargin: 1.16 // 16% margin for right axis
    };

    // Allow overrides
    Object.assign(this, options);
  }

  getDPR() {
    return window.devicePixelRatio || 1;
  }
}

/**
 * ChartData - Data validation and transformation
 */
class ChartData {
  constructor(xValues, series) {
    this.x = this.sanitize(xValues);
    this.series = series.map(s => ({
      data: this.sanitize(s.data),
      label: s.label || '',
      color: s.color || '#000000',
      axis: s.axis || 'left',
      formatType: s.formatType || 'currency'
    }));
  }

  sanitize(arr) {
    return arr.map(v => Number.isFinite(v) ? v : 0);
  }

  getBounds(arr) {
    const finite = arr.filter(Number.isFinite);
    if (!finite.length) return { min: 0, max: 1 };
    return {
      min: Math.min(...finite),
      max: Math.max(...finite)
    };
  }

  getMax(arr, fallback = 1) {
    const finite = arr.filter(Number.isFinite);
    return finite.length ? Math.max(...finite, fallback) : fallback;
  }

  getXBounds() {
    return this.getBounds(this.x);
  }

  getSeriesBounds(axisType = 'left') {
    const filtered = this.series
      .filter(s => s.axis === axisType)
      .flatMap(s => s.data);
    return this.getBounds(filtered);
  }

  getSeriesMax(axisType = 'left') {
    const filtered = this.series
      .filter(s => s.axis === axisType)
      .flatMap(s => s.data);
    return this.getMax(filtered);
  }
}

/**
 * ChartAxis - Handles axis scaling, ticks, and labels
 */
class ChartAxis {
  constructor(config, data, type = 'left') {
    this.config = config;
    this.data = data;
    this.type = type;
    this.setupScale();
  }

  setupScale() {
    const margin = this.type === 'right'
      ? this.config.axis.rightAxisMargin
      : this.config.axis.topMargin;

    this.min = 0;
    this.max = this.data.getSeriesMax(this.type) * margin;
    this.range = this.max - this.min || 1;
  }

  scale(value, plotHeight, plotTop, plotBottom) {
    const normalized = (value - this.min) / this.range;
    return plotTop + (1 - normalized) * plotHeight;
  }

  getTicks(count = 5) {
    const ticks = [];
    for (let i = 0; i < count; i++) {
      const frac = 1 - i / (count - 1);
      ticks.push({
        value: this.min + frac * this.range,
        position: i / (count - 1)
      });
    }
    return ticks;
  }

  formatLabel(value, formatType = 'currency') {
    if (formatType === 'currency') {
      if (Math.abs(value) >= 1000000) {
        const millions = value / 1000000;
        // Show whole number if no decimal needed, otherwise one decimal place
        return (millions % 1 === 0 ? millions.toFixed(0) : millions.toFixed(1)) + 'M';
      }
      return (value / 1000).toFixed(0) + 'k';
    } else if (formatType === 'rent') {
      return '$' + value.toFixed(0);
    }
    return value.toFixed(0);
  }
}

/**
 * ChartGrid - Background grid rendering
 */
class ChartGrid {
  constructor(config) {
    this.config = config;
  }

  render(ctx, bounds, dpr) {
    const { plotLeft, plotRight, plotTop, plotHeight } = bounds;

    ctx.strokeStyle = this.config.colors.grid;
    ctx.lineWidth = this.config.grid.lineWidth * dpr;

    const divisions = this.config.grid.divisions;
    for (let i = 0; i <= divisions; i++) {
      const y = plotTop + i * (plotHeight / divisions);
      ctx.beginPath();
      ctx.moveTo(plotLeft, y);
      ctx.lineTo(plotRight, y);
      ctx.stroke();
    }
  }
}

/**
 * ChartSeries - Renders data series (lines and points)
 */
class ChartSeries {
  constructor(config) {
    this.config = config;
  }

  render(ctx, xValues, yValues, xScale, yScale, color, dpr) {
    if (xValues.length === 0 || yValues.length === 0) return;

    // Draw line
    ctx.strokeStyle = color;
    ctx.lineWidth = this.config.line.width * dpr;
    ctx.beginPath();

    xValues.forEach((x, idx) => {
      const px = xScale(x);
      const py = yScale(yValues[idx]);
      if (idx === 0) {
        ctx.moveTo(px, py);
      } else {
        ctx.lineTo(px, py);
      }
    });
    ctx.stroke();

    // Draw points
    ctx.fillStyle = color;
    xValues.forEach((x, idx) => {
      const px = xScale(x);
      const py = yScale(yValues[idx]);
      ctx.beginPath();
      ctx.arc(px, py, this.config.line.pointRadius * dpr, 0, Math.PI * 2);
      ctx.fill();
    });
  }
}

/**
 * ChartLegend - Legend rendering
 */
class ChartLegend {
  constructor(config) {
    this.config = config;
  }

  render(ctx, series, bounds, dpr) {
    const { plotLeft, plotTop } = bounds;
    const { boxSize, spacing, offset } = this.config.legend;

    const lx = plotLeft;
    const ly = plotTop - offset.y * dpr;

    ctx.fillStyle = this.config.colors.legendLabel;
    ctx.textAlign = 'left';

    series.forEach((s, idx) => {
      const xPos = lx + idx * spacing * dpr;

      // Draw color box
      ctx.fillStyle = s.color;
      ctx.fillRect(xPos, ly - boxSize * dpr, boxSize * dpr, boxSize * dpr);

      // Draw label
      ctx.fillStyle = this.config.colors.legendLabel;
      ctx.fillText(s.label, xPos + offset.x * dpr, ly);
    });
  }
}

/**
 * ChartRenderer - Main chart orchestrator
 */
class ChartRenderer {
  constructor(canvas, config = null) {
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this.config = config || new ChartConfig();
    this.grid = new ChartGrid(this.config);
    this.seriesRenderer = new ChartSeries(this.config);
    this.legend = new ChartLegend(this.config);
  }

  setupCanvas() {
    const dpr = this.config.getDPR();
    const rect = this.canvas.getBoundingClientRect();
    const cssW = Math.max(320, rect.width || 0);
    const cssH = Math.max(140, parseInt(this.canvas.getAttribute('height') || '160', 10));

    this.canvas.width = Math.floor(cssW * dpr);
    this.canvas.height = Math.floor(cssH * dpr);

    return { dpr, w: this.canvas.width, h: this.canvas.height };
  }

  getBounds(w, h, dpr) {
    const pad = this.config.padding;
    return {
      plotLeft: pad.left * dpr,
      plotRight: w - pad.right * dpr,
      plotTop: pad.top * dpr,
      plotBottom: h - pad.bottom * dpr,
      plotWidth: w - (pad.left + pad.right) * dpr,
      plotHeight: h - (pad.top + pad.bottom) * dpr
    };
  }

  createScaleFunctions(data, bounds) {
    const xBounds = data.getXBounds();
    const xRange = xBounds.max - xBounds.min || 1;

    const xScale = (x) => {
      return bounds.plotLeft + ((x - xBounds.min) / xRange) * bounds.plotWidth;
    };

    return { xBounds, xScale };
  }

  renderAxes(data, bounds, dpr, hasRightAxis = false) {
    const leftAxis = new ChartAxis(this.config, data, 'left');
    const rightAxis = hasRightAxis ? new ChartAxis(this.config, data, 'right') : null;

    // Setup font
    this.ctx.font = `${this.config.font.size * dpr}px ${this.config.font.family}`;
    this.ctx.fillStyle = this.config.colors.label;

    // Left axis labels
    const leftTicks = leftAxis.getTicks(this.config.grid.divisions + 1);
    this.ctx.textAlign = 'left';
    leftTicks.forEach(tick => {
      const y = bounds.plotTop + tick.position * bounds.plotHeight;
      const leftSeries = data.series.find(s => s.axis === 'left');
      const label = leftAxis.formatLabel(tick.value, leftSeries?.formatType);
      this.ctx.fillText(label, 8 * dpr, y + 4 * dpr);
    });

    // Right axis labels
    if (rightAxis) {
      this.ctx.textAlign = 'right';
      const rightTicks = rightAxis.getTicks(this.config.grid.divisions + 1);
      rightTicks.forEach(tick => {
        const y = bounds.plotTop + tick.position * bounds.plotHeight;
        const rightSeries = data.series.find(s => s.axis === 'right');
        const label = rightAxis.formatLabel(tick.value, rightSeries?.formatType);
        this.ctx.fillText(label, bounds.plotRight + 42 * dpr, y + 4 * dpr);
      });
    }

    return { leftAxis, rightAxis };
  }

  renderXLabels(xValues, xScale, bounds, dpr) {
    this.ctx.fillStyle = this.config.colors.label;
    this.ctx.textAlign = 'center';

    xValues.forEach(x => {
      const px = xScale(x);
      const label = 'Y' + x;
      this.ctx.fillText(label, px, bounds.plotBottom + 22 * dpr);
    });
  }

  render(xValues, series) {
    if (!this.ctx) return;

    // Setup
    const { dpr, w, h } = this.setupCanvas();
    this.ctx.clearRect(0, 0, w, h);

    // Create data model
    const data = new ChartData(xValues, series);
    const bounds = this.getBounds(w, h, dpr);

    // Render grid
    this.grid.render(this.ctx, bounds, dpr);

    // Check if we have right axis
    const hasRightAxis = series.some(s => s.axis === 'right');

    // Render axes
    const { leftAxis, rightAxis } = this.renderAxes(data, bounds, dpr, hasRightAxis);

    // Create scale functions
    const { xScale } = this.createScaleFunctions(data, bounds);

    // Render X labels
    this.renderXLabels(data.x, xScale, bounds, dpr);

    // Render series
    data.series.forEach(s => {
      const axis = s.axis === 'right' && rightAxis ? rightAxis : leftAxis;
      const yScale = (y) => axis.scale(y, bounds.plotHeight, bounds.plotTop, bounds.plotHeight);
      this.seriesRenderer.render(this.ctx, data.x, s.data, xScale, yScale, s.color, dpr);
    });

    // Render legend
    this.legend.render(this.ctx, data.series, bounds, dpr);
  }
}

// ============================================================================
// PUBLIC API - Simplified chart drawing functions
// ============================================================================

function drawDualAxis(canvas, xVals, leftSeries, rightSeries, leftLabel, rightLabel) {
  const renderer = new ChartRenderer(canvas);

  const series = [
    {
      data: leftSeries,
      label: leftLabel,
      color: '#1B4332',
      axis: 'left',
      formatType: 'currency'
    },
    {
      data: rightSeries,
      label: rightLabel,
      color: '#D4AF37',
      axis: 'right',
      formatType: (rightLabel === 'Loan' || rightLabel === 'Value') ? 'currency' : 'rent'
    }
  ];

  renderer.render(xVals, series);
}

function drawSingle(canvas, xVals, series, label) {
  const renderer = new ChartRenderer(canvas);

  const seriesConfig = [
    {
      data: series,
      label: label,
      color: '#1B4332',
      axis: 'left',
      formatType: 'currency'
    }
  ];

  renderer.render(xVals, seriesConfig);
}

function render(){
  const i = getInputs();
  const o = compute(i);

  $("outDeposit").textContent = fmtAUD0(o.deposit);
  $("outLoanAmt").textContent = fmtAUD0(o.loanAmount);
  $("outLvr").textContent = fmtPct(o.lvr);

  $("outLmi").textContent = fmtAUD0(o.lmi);
  $("outDuty").textContent = fmtAUD0(o.stampDuty);
  $("outDepr").textContent = fmtAUD0(o.depreciationYr);

  $("outCashRequired").textContent = fmtAUD0(o.cashRequired);
  $("outCashRequiredSub").textContent = `Deposit ${fmtAUD0(o.deposit)} + LMI ${fmtAUD0(o.lmi)} + Duty ${fmtAUD0(o.stampDuty)}`;

  $("outMonthlyPAndI").textContent = fmtAUD2(o.monthlyPAndI);
  $("outInterestOnly").textContent = fmtAUD2(o.interestPortionMonth1);

  $("outNetRentYr").textContent = fmtAUD0(o.netRentYr);
  $("outYield").textContent = fmtPct(o.yieldGross);

  $("outExpenseYr").textContent = fmtOutflowAUD(o.annualExpense, 0);
  $("outCashflowYrPreTax").textContent = fmtSignedAUD(o.cashflowYrPreTax, 0);
  $("outCashPreTax").textContent = fmtSignedAUD(o.cashflowMonthPreTax, 2);

  $("outTaxBenefit").textContent = fmtAUD2(o.taxBenefit);
  $("outNetCashMonth").textContent = fmtSignedAUD(o.cashflowMonthAfterTax, 2);

  const addr = i.address ? i.address : "Property";
  const ir = parsePercentLoose($("interestRate").value) * 100;
  $("reportLine").textContent =
    `${addr} (${i.state}) • Purchase ${fmtAUD0(i.purchasePrice)} • LVR ${(o.lvr*100).toFixed(1)}% • Rate ${isFinite(ir)?ir.toFixed(2):"0.00"}% • Net cashflow ${fmtSignedAUD(o.cashflowMonthAfterTax,2)}/mo`;

  requestAnimationFrame(() => renderProjection(o, i));
}

const sample = {
  address: "5 Henschke Court, Caboolture QLD 4510",
  state: "QLD",
  purchasePrice: 565000,
  depositPct: 0.20,
  interestRate: 0.055,
  loanTermYears: 30,
  rentWeek: 550,
  rentComm: 0.08,
  councilYr: 4000,
  buildingInsYr: 1500,
  landlordInsYr: 500,
  maintenanceYr: 3000,
  accountingYr: 0,
  superYr: 0,
  buildingValuePct: 0.70,
  deprRatePct: 0.025,
  taxDeductRatio: 1.00,
  taxRate: 0.30,
  capGrowthPct: 6,
  rentGrowthPct: 3,
  cashflowGrowthPct: 2
};

function setForm(v){
  $("address").value = v.address ?? "";
  $("state").value = v.state ?? "QLD";
  $("purchasePrice").value = v.purchasePrice ?? 0;

  $("depositPct").value = ((v.depositPct ?? 0) * 100).toFixed(0);
  $("interestRate").value = ((v.interestRate ?? 0) * 100).toFixed(2);
  $("loanTermYears").value = v.loanTermYears ?? 30;

  $("rentWeek").value = v.rentWeek ?? 0;
  $("rentComm").value = ((v.rentComm ?? 0) * 100).toFixed(0);

  $("councilYr").value = v.councilYr ?? 0;
  $("buildingInsYr").value = v.buildingInsYr ?? 0;
  $("landlordInsYr").value = v.landlordInsYr ?? 0;
  $("maintenanceYr").value = v.maintenanceYr ?? 0;
  $("accountingYr").value = v.accountingYr ?? 0;
  $("superYr").value = v.superYr ?? 0;

  $("buildingValuePct").value = ((v.buildingValuePct ?? 0.70) * 100).toFixed(0);
  $("deprRatePct").value = ((v.deprRatePct ?? 0.025) * 100).toFixed(2);

  $("taxDeductRatio").value = ((v.taxDeductRatio ?? 1) * 100).toFixed(0);
  $("taxRate").value = ((v.taxRate ?? 0.30) * 100).toFixed(0);

  $("capGrowthPct").value = (v.capGrowthPct ?? 6).toString();
  $("rentGrowthPct").value = (v.rentGrowthPct ?? 3).toString();
  $("cashflowGrowthPct").value = (v.cashflowGrowthPct ?? 2).toString();

  render();
}

const inputs = [
  "address","state","purchasePrice","depositPct","interestRate","loanTermYears",
  "rentWeek","rentComm",
  "councilYr","buildingInsYr","landlordInsYr","maintenanceYr","accountingYr","superYr",
  "buildingValuePct","deprRatePct","taxDeductRatio","taxRate",
  "capGrowthPct","rentGrowthPct","cashflowGrowthPct"
];

inputs.forEach(id => $(id).addEventListener("input", render));
$("state").addEventListener("change", render);

// Collapsible Advanced section
$("advancedHeader").addEventListener("click", () => {
  const header = $("advancedHeader");
  const content = $("advancedContent");
  const wasActive = header.classList.contains("active");

  header.classList.toggle("active");
  content.classList.toggle("active");

  // If we just opened the section, re-render the chart after a short delay
  // to ensure the canvas has proper dimensions
  if (!wasActive) {
    setTimeout(() => {
      render();
    }, 100);
  }
});

(function attachResizeObserver(){
  const canvas = $("portfolioChart");
  if (!canvas) return;
  const rerender = () => requestAnimationFrame(render);
  window.addEventListener("resize", rerender);
  if ("ResizeObserver" in window){
    const ro = new ResizeObserver(rerender);
    ro.observe(canvas);
    if (canvas.parentElement) ro.observe(canvas.parentElement);
  }
})();

$("btnReset").addEventListener("click", () => setForm(sample));

$("btnExport").addEventListener("click", async () => {
  const json = JSON.stringify(getInputs(), null, 2);
  try{
    await navigator.clipboard.writeText(json);
    alert("Copied inputs to clipboard.");
  }catch(e){
    const w = window.open();
    w.document.write(`<pre>${json.replace(/[<>]/g, s => ({'<':'&lt;','>':'&gt;'}[s]))}</pre>`);
    w.document.close();
  }
});

window.addEventListener("load", () => setTimeout(() => setForm(sample), 0));

// Warning Modal Management
(function initWarningModal(){
  const STORAGE_KEY = 'smartgain_disclaimer_accepted';
  const modal = $('warningModal');
  const acceptBtn = $('acceptWarning');

  // Check if user has already accepted the disclaimer
  const hasAccepted = localStorage.getItem(STORAGE_KEY);

  // Show modal if not yet accepted
  if (!hasAccepted) {
    // Small delay to ensure page is loaded and animation works smoothly
    setTimeout(() => {
      modal.classList.add('active');
    }, 300);
  }

  // Handle accept button click
  acceptBtn.addEventListener('click', () => {
    // Store acceptance in localStorage
    localStorage.setItem(STORAGE_KEY, 'true');

    // Hide modal with animation
    modal.classList.remove('active');
  });

  // Prevent closing modal by clicking overlay (user must accept)
  modal.addEventListener('click', (e) => {
    // Only allow closing by clicking the accept button
    if (e.target === modal) {
      // Optional: could add a subtle shake animation here to indicate they must accept
      e.stopPropagation();
    }
  });
})();

  </script>
</body>
</html>
